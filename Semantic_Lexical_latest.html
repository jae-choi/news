<!DOCTYPE html>
<html lang="ko" class="lang-ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GenAI Search System Guide</title>
    <link rel="icon" href="https://avatars.githubusercontent.com/u/35217573?v=4" type="image/png" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script>hljs.highlightAll();</script>
    <style>
        body {
            font-family: 'Inter', 'Noto Sans KR', sans-serif;
        }
        .gradient-text {
            background: linear-gradient(to right, #4f46e5, #ec4899);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        code.language-python, code.language-sql, code.language-bash {
            font-family: 'Fira Code', 'D2Coding', monospace;
        }
        pre code.hljs {
            display: block;
            padding: 1.5rem;
            border-radius: 0.5rem;
            white-space: pre-wrap;
            word-break: break-all;
        }
        .tag {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-weight: 500;
            font-size: 0.875rem;
        }
        pre:hover {
            filter: brightness(120%);
            transition: filter 0.2s ease;
        }
        .sidebar {
            position: fixed;
            top: 10rem;
            left: 2rem;
            background: white;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            padding: 1rem;
            width: 22rem;
        }
        .sidebar .menu-item > a {
            display: block;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            color: #4b5563;
            font-weight: 600; /* Bolder for main categories */
            transition: background-color 0.2s, color 0.2s;
            cursor: pointer;
        }
        .sidebar .submenu a {
            display: block;
            padding: 0.4rem 1rem 0.4rem 2rem; /* Indented */
            border-radius: 0.375rem;
            color: #6b7280;
            font-weight: 400; /* Lighter for sub-categories */
            font-size: 0.9rem; /* Smaller font for sub-categories */
            transition: background-color 0.2s, color 0.2s;
        }
        .sidebar a:hover {
            background-color: #f3f4f6;
        }
        .sidebar a.active {
            background-color: #4f46e5;
            color: white !important;
        }
        .sidebar .submenu {
            display: none; /* Hide submenu by default */
            padding-left: 0;
            margin-top: 0.25rem;
            margin-bottom: 0.25rem;
        }
        .sidebar .menu-item.open > .submenu {
            display: block; /* Show submenu when parent is open */
        }
        @keyframes pulse-arrow {
            0%, 100% { transform: translateX(0) rotate(var(--tw-rotate)); }
            50% { transform: translateX(5px) rotate(var(--tw-rotate)); }
        }
        .arrow-animate {
            animation: pulse-arrow 1.5s ease-in-out infinite;
        }
        @media (max-width: 1280px) {
            .sidebar {
                display: none;
            }
        }
        /* Language switcher styles */
        .lang-ko .lang-en,
        .lang-en .lang-ko {
            display: none;
        }
        .lang-btn {
            transition: all 0.2s ease-in-out;
            border-radius: 9999px;
            padding: 0.25rem 0.75rem;
            font-size: 0.875rem;
            border: 1px solid transparent;
        }
        .lang-btn.active {
            font-weight: 600;
            background-color: #4f46e5; /* indigo-600 */
            color: white;
        }
        .lang-btn:not(.active) {
            color: #4b5563; /* gray-600 */
            background-color: transparent;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <!-- Sidebar Navigation -->
    <nav class="sidebar">
        <div class="menu-item"><a href="#overview"><span class="lang lang-ko">1. ê°œìš”</span><span class="lang lang-en">1. Overview</span></a></div>
        <div class="menu-item"><a href="#architecture"><span class="lang lang-ko">2. ì•„í‚¤í…ì²˜</span><span class="lang lang-en">2. Architecture</span></a></div>
        <div class="menu-item">
            <a data-toggle-submenu><span class="lang lang-ko">3. ì½”ë“œ êµ¬ì¡°</span><span class="lang lang-en">3. Code Structure</span></a>
            <div class="submenu">
                <a href="#functions-core"><span class="lang lang-ko">3.1. í•µì‹¬ í•¨ìˆ˜</span><span class="lang lang-en">3.1. Core Functions</span></a>
                <a href="#functions-full-code"><span class="lang lang-ko">3.2. ì „ì²´ ì½”ë“œ</span><span class="lang lang-en">3.2. Full Code</span></a>
                <a href="#functions-adk-guide"><span class="lang lang-ko">3.3. ADK ì „í™˜ ê°€ì´ë“œ</span><span class="lang lang-en">3.3. ADK Conversion Guide</span></a>
            </div>
        </div>
        <div class="menu-item">
            <a data-toggle-submenu><span class="lang lang-ko">4. ì‹¤í–‰ ë°©ë²•</span><span class="lang lang-en">4. Execution Guide</span></a>
            <div class="submenu">
                <a href="#execution-data-prep"><span class="lang lang-ko">4.1. ë°ì´í„° ì¤€ë¹„</span><span class="lang lang-en">4.1. Data Preparation</span></a>
                <a href="#execution-prereqs"><span class="lang lang-ko">4.2. ì‚¬ì „ ì¤€ë¹„ ì‚¬í•­</span><span class="lang lang-en">4.2. Prerequisites</span></a>
            </div>
        </div>
    </nav>

    <div class="container px-4 py-12 max-w-5xl xl:ml-[26rem]">
        
        <div class="flex justify-end items-center mb-8">
            <div class="flex items-center bg-white rounded-full p-1 shadow-md">
                <button id="btn-ko" class="lang-btn" onclick="switchLang('ko')">KOR</button>
                <button id="btn-en" class="lang-btn" onclick="switchLang('en')">ENG</button>
            </div>
        </div>

        <!-- Header -->
        <header class="text-center mb-16">
            <h1 class="text-4xl md:text-5xl font-bold tracking-tight mb-4">
                <span class="gradient-text"><span class="lang lang-ko">GenAI ê¸°ë°˜ ê²€ìƒ‰ì‹œìŠ¤í…œ êµ¬ì¶•</span><span class="lang lang-en">Building a GenAI-Powered Search System</span></span>
            </h1>
            <p class="text-lg text-gray-600"><span class="lang lang-ko">Discovery Engineê³¼ LLMì„ í™œìš©í•œ Q&A ì±—ë´‡ ê°œë°œ ê°€ì´ë“œ</span><span class="lang lang-en">A Guide to Developing a Q&A Chatbot using Discovery Engine and LLMs</span></p>
        </header>

        <main class="space-y-16">

            <!-- Section 1: ê°œìš” -->
            <section id="overview" class="card p-8">
                <h2 class="flex items-center text-2xl font-bold mb-6 border-b pb-4">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-3 text-indigo-500"><path d="m12 14 4-4"></path><path d="M3.34 19a10 10 0 1 1 17.32 0"></path></svg>
                    <span class="lang lang-ko">1. ê°œìš”</span><span class="lang lang-en">1. Overview</span>
                </h2>
                <p class="mb-8 text-gray-600">
                    <span class="lang lang-ko">ì´ ì• í”Œë¦¬ì¼€ì´ì…˜ì€ Streamlitì„ ì‚¬ìš©í•˜ì—¬ êµ¬ì¶•ëœ ëŒ€í™”í˜• Q&A ì‹œìŠ¤í…œì…ë‹ˆë‹¤. ì‚¬ìš©ìê°€ ìì—°ì–´ ì§ˆë¬¸ì„ ì…ë ¥í•˜ë©´, Google Cloudì˜ Discovery Engineê³¼ BigQueryë¥¼ í†µí•´ ì—°êµ¬ ë…¼ë¬¸ ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ê²€ìƒ‰í•˜ê³ , Google Gemini Pro (LLM)ë¥¼ í™œìš©í•˜ì—¬ ì§ˆë¬¸ì— ëŒ€í•œ ë‹µë³€ì„ ìƒì„±í•©ë‹ˆë‹¤.</span>
                    <span class="lang lang-en">This application is an interactive Q&A system built using Streamlit. When a user enters a natural language question, it searches a research paper database via Google Cloud's Discovery Engine and BigQuery, and generates an answer using Google Gemini Pro (LLM).</span>
                </p>

                <div class="grid md:grid-cols-2 gap-8">
                    <div>
                        <h3 class="text-xl font-semibold mb-4"><span class="lang lang-ko">ì£¼ìš” ê¸°ëŠ¥</span><span class="lang lang-en">Key Features</span></h3>
                        <ul class="space-y-3">
                            <li class="flex items-start"><span class="text-indigo-500 mr-3 mt-1">âœ“</span><span><strong><span class="lang lang-ko">ìì—°ì–´ ì§ˆì˜ì‘ë‹µ:</span><span class="lang lang-en">Natural Language Q&A:</span></strong> <span class="lang lang-ko">ë…¼ë¬¸ ë‚´ìš©, ì €ì, ì—°ë„ ë“± ë‹¤ì–‘í•œ ì¡°ê±´ìœ¼ë¡œ ì§ˆë¬¸</span><span class="lang lang-en">Ask questions with various criteria like content, author, and year.</span></span></li>
                            <li class="flex items-start"><span class="text-indigo-500 mr-3 mt-1">âœ“</span><span><strong><span class="lang lang-ko">ì •í™•í•œ ID ê²€ìƒ‰:</span><span class="lang lang-en">Exact ID Search:</span></strong> <span class="lang lang-ko">BigQueryì—ì„œ ì§ì ‘ ë°ì´í„°ë¥¼ ì¡°íšŒí•˜ì—¬ ë¹ ë¥´ê³  ì •í™•í•œ ê²€ìƒ‰ ì§€ì›</span><span class="lang lang-en">Supports fast and accurate search by directly querying data from BigQuery.</span></span></li>
                            <li class="flex items-start"><span class="text-indigo-500 mr-3 mt-1">âœ“</span><span><strong><span class="lang lang-ko">ì˜ë¯¸ ê¸°ë°˜ ê²€ìƒ‰:</span><span class="lang lang-en">Semantic Search:</span></strong> <span class="lang lang-ko">Discovery Engineìœ¼ë¡œ ì‚¬ìš©ì ì˜ë„ë¥¼ íŒŒì•…í•˜ì—¬ ìœ ì‚¬ ë¬¸ì„œ ê²€ìƒ‰</span><span class="lang lang-en">Searches for similar documents by understanding user intent with Discovery Engine.</span></span></li>
                            <li class="flex items-start"><span class="text-indigo-500 mr-3 mt-1">âœ“</span><span><strong><span class="lang lang-ko">ë³µí•© ë° í›„ì† ì§ˆë¬¸ ì²˜ë¦¬:</span><span class="lang lang-en">Complex & Follow-up Questions:</span></strong> <span class="lang lang-ko">ëŒ€í™” ë§¥ë½ì„ ê¸°ì–µí•˜ì—¬ í›„ì† ì§ˆë¬¸ ì²˜ë¦¬</span><span class="lang lang-en">Handles follow-up questions by remembering the conversation context.</span></span></li>
                            <li class="flex items-start"><span class="text-indigo-500 mr-3 mt-1">âœ“</span><span><strong><span class="lang lang-ko">ê´€ë ¨ ë…¼ë¬¸ ì¶”ì²œ:</span><span class="lang lang-en">Related Paper Recommendations:</span></strong> <span class="lang lang-ko">TF-IDFì™€ ì½”ì‚¬ì¸ ìœ ì‚¬ë„ ê¸°ë°˜ìœ¼ë¡œ ê´€ë ¨ ë…¼ë¬¸ ì¶”ì²œ</span><span class="lang lang-en">Recommends related papers based on TF-IDF and cosine similarity.</span></span></li>
                            <li class="flex items-start"><span class="text-indigo-500 mr-3 mt-1">âœ“</span><span><strong><span class="lang lang-ko">ëŒ€í™” íˆìŠ¤í† ë¦¬ ë° ì‹œê°í™”:</span><span class="lang lang-en">History & Visualization:</span></strong> <span class="lang lang-ko">ëŒ€í™” ê¸°ë¡ ê´€ë¦¬ ë° ê²€ìƒ‰ ê²°ê³¼ ì‹œê°í™”</span><span class="lang lang-en">Manages conversation history and visualizes search results.</span></span></li>
                        </ul>
                    </div>
                    <div>
                        <h3 class="text-xl font-semibold mb-4"><span class="lang lang-ko">ì‚¬ìš© ê¸°ìˆ  ìŠ¤íƒ</span><span class="lang lang-en">Technology Stack</span></h3>
                        <div class="flex flex-wrap gap-3">
                            <span class="tag bg-blue-100 text-blue-800">Streamlit</span>
                            <span class="tag bg-green-100 text-green-800">Google Gemini Pro</span>
                            <span class="tag bg-yellow-100 text-yellow-800">Discovery Engine</span>
                            <span class="tag bg-purple-100 text-purple-800">BigQuery</span>
                            <span class="tag bg-red-100 text-red-800">Pandas</span>
                            <span class="tag bg-gray-200 text-gray-800">Scikit-learn</span>
                            <span class="tag bg-indigo-100 text-indigo-800">LangChain</span>
                            <span class="tag bg-green-200 text-green-900">Google ADK</span>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Section 2: ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜ -->
            <section id="architecture" class="card p-8">
                <h2 class="flex items-center text-2xl font-bold mb-6 border-b pb-4">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-3 text-indigo-500"><path d="M12 20V10"></path><path d="M18 20V4"></path><path d="M6 20V16"></path></svg>
                    <span class="lang lang-ko">2. ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜</span><span class="lang lang-en">2. System Architecture</span>
                </h2>

                <!-- Infographic Start -->
                <div class="my-10 p-6 bg-slate-50 rounded-xl border border-slate-200">
                    <h3 class="font-semibold text-xl text-center mb-8 text-slate-700"><span class="lang lang-ko">ì‹œìŠ¤í…œ êµ¬ì„±ë„</span><span class="lang lang-en">System Diagram</span></h3>
                    <div class="flex flex-col md:flex-row items-center justify-center space-y-6 md:space-y-0 md:space-x-4">
                        
                        <!-- Step 1: Input -->
                        <div class="flex flex-col items-center text-center w-40">
                            <div class="w-20 h-20 rounded-full bg-blue-100 flex items-center justify-center border-2 border-blue-200">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-10 h-10 text-blue-600"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg>
                            </div>
                            <div class="mt-3 flex flex-col justify-center" style="min-height: 60px;">
                                <p class="font-bold text-slate-800"><span class="lang lang-ko">1. ì§ˆì˜</span><span class="lang lang-en">1. Query</span></p>
                                <p class="text-sm text-slate-500"><span class="lang lang-ko">ì‚¬ìš©ì ì…ë ¥</span><span class="lang lang-en">User Input</span></p>
                            </div>
                        </div>

                        <div class="text-3xl text-slate-400 transform md:rotate-0 rotate-90 arrow-animate">â€º</div>

                        <!-- Step 2: Analysis -->
                        <div class="flex flex-col items-center text-center w-40">
                            <div class="w-20 h-20 rounded-full bg-purple-100 flex items-center justify-center border-2 border-purple-200">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-10 h-10 text-purple-600"><path d="m21.73 18-8-14a2 2 0 0 0-3.46 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/></svg>
                            </div>
                            <div class="mt-3 flex flex-col justify-center" style="min-height: 60px;">
                                <p class="font-bold text-slate-800"><span class="lang lang-ko">2. ë¶„ì„/ê²€ìƒ‰</span><span class="lang lang-en">2. Analyze/Search</span></p>
                                <p class="text-sm text-slate-500"><span class="lang lang-ko">ìœ í˜• ë¶„ì„ ë°<br>ë°ì´í„° ì¡°íšŒ</span><span class="lang lang-en">Type Analysis &<br>Data Retrieval</span></p>
                            </div>
                        </div>

                        <div class="text-3xl text-slate-400 transform md:rotate-0 rotate-90 arrow-animate">â€º</div>

                        <!-- Step 3: Generation -->
                        <div class="flex flex-col items-center text-center w-40">
                            <div class="w-20 h-20 rounded-full bg-green-100 flex items-center justify-center border-2 border-green-200">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-10 h-10 text-green-600"><path d="M12 8V4H8"/><rect width="16" height="12" x="4" y="8" rx="2"/><path d="M2 14h2"/><path d="M20 14h2"/><path d="M15 13v2"/><path d="M9 13v2"/></svg>
                            </div>
                            <div class="mt-3 flex flex-col justify-center" style="min-height: 60px;">
                                <p class="font-bold text-slate-800"><span class="lang lang-ko">3. ìƒì„±</span><span class="lang lang-en">3. Generate</span></p>
                                <p class="text-sm text-slate-500"><span class="lang lang-ko">LLM í”„ë¡¬í”„íŠ¸ ë°<br>ë‹µë³€ ìƒì„±</span><span class="lang lang-en">LLM Prompt &<br>Answer Generation</span></p>
                            </div>
                        </div>

                        <div class="text-3xl text-slate-400 transform md:rotate-0 rotate-90 arrow-animate">â€º</div>

                        <!-- Step 4: Display -->
                        <div class="flex flex-col items-center text-center w-40">
                            <div class="w-20 h-20 rounded-full bg-pink-100 flex items-center justify-center border-2 border-pink-200">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-10 h-10 text-pink-600"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><line x1="10" y1="9" x2="8" y2="9"/></svg>
                            </div>
                            <div class="mt-3 flex flex-col justify-center" style="min-height: 60px;">
                                <p class="font-bold text-slate-800"><span class="lang lang-ko">4. ê²°ê³¼</span><span class="lang lang-en">4. Result</span></p>
                                <p class="text-sm text-slate-500"><span class="lang lang-ko">UI ë Œë”ë§ ë°<br>ìŠ¤íŠ¸ë¦¬ë°</span><span class="lang lang-en">UI Rendering &<br>Streaming</span></p>
                            </div>
                        </div>
                    </div>
                    <div class="mt-6 text-center text-sm text-slate-600">
                        <p><strong><span class="lang lang-ko">ì£¼ìš” êµ¬ì„± ìš”ì†Œ:</span><span class="lang lang-en">Key Components:</span></strong> Google Discovery Engine, BigQuery, Gemini Pro, Streamlit/ADK</p>
                    </div>
                </div>
                <!-- Infographic End -->
                <ol class="relative border-l border-gray-200 space-y-10 ml-4">
                    <li class="ml-6">
                        <span class="absolute flex items-center justify-center w-8 h-8 bg-indigo-100 rounded-full -left-4 ring-8 ring-white">1</span>
                        <h3 class="font-semibold text-lg"><span class="lang lang-ko">ì§ˆë¬¸ ì…ë ¥ (User Input)</span><span class="lang lang-en">User Input</span></h3>
                        <p class="text-gray-600"><span class="lang lang-ko">ì‚¬ìš©ìê°€ ì›¹ UI(Streamlit ë˜ëŠ” ADK Web)ì—ì„œ ì§ˆë¬¸ì„ ì…ë ¥í•©ë‹ˆë‹¤.</span><span class="lang lang-en">The user enters a question in the web UI (Streamlit or ADK Web).</span></p>
                    </li>
                    <li class="ml-6">
                        <span class="absolute flex items-center justify-center w-8 h-8 bg-indigo-100 rounded-full -left-4 ring-8 ring-white">2</span>
                        <h3 class="font-semibold text-lg"><span class="lang lang-ko">ì§ˆì˜ ìœ í˜• ë¶„ì„ (Query Analysis)</span><span class="lang lang-en">Query Analysis</span></h3>
                        <p class="text-gray-600"><span class="lang lang-ko">ID, í›„ì† ì§ˆë¬¸ í‚¤ì›Œë“œ ë“±ì„ ë¶„ì„í•˜ì—¬ ì§ˆë¬¸ ìœ í˜•ì„ íŒë‹¨í•©ë‹ˆë‹¤.</span><span class="lang lang-en">The system analyzes keywords for IDs, follow-up questions, etc., to determine the query type.</span></p>
                    </li>
                    <li class="ml-6">
                        <span class="absolute flex items-center justify-center w-8 h-8 bg-indigo-100 rounded-full -left-4 ring-8 ring-white">3</span>
                        <h3 class="font-semibold text-lg"><span class="lang lang-ko">ë°ì´í„° ê²€ìƒ‰ (Data Retrieval)</span><span class="lang lang-en">Data Retrieval</span></h3>
                        <p class="text-gray-600"><span class="lang lang-ko">ID ê²€ìƒ‰ì€ BigQuery, ê·¸ ì™¸ëŠ” Discovery Engineì„ ì‚¬ìš©í•©ë‹ˆë‹¤. ADKì—ì„œëŠ” ì´ ê¸°ëŠ¥ë“¤ì´ `@tool`ë¡œ ì •ì˜ë©ë‹ˆë‹¤.</span><span class="lang lang-en">BigQuery is used for ID searches, and Discovery Engine for all others. In ADK, these functions are defined as `@tool`.</span></p>
                    </li>
                    <li class="ml-6">
                        <span class="absolute flex items-center justify-center w-8 h-8 bg-indigo-100 rounded-full -left-4 ring-8 ring-white">4</span>
                        <h3 class="font-semibold text-lg"><span class="lang lang-ko">ë°ì´í„° í•„í„°ë§ ë° ì •ì œ (Filtering & Refinement)</span><span class="lang lang-en">Filtering & Refinement</span></h3>
                        <p class="text-gray-600"><span class="lang lang-ko">í‚¤ì›Œë“œ, ì—°ë„, ìœ ì‚¬ë„ ë“±ìœ¼ë¡œ ê²€ìƒ‰ ê²°ê³¼ë¥¼ ì •ì œí•©ë‹ˆë‹¤.</span><span class="lang lang-en">Search results are refined by keyword, year, similarity, etc.</span></p>
                    </li>
                    <li class="ml-6">
                        <span class="absolute flex items-center justify-center w-8 h-8 bg-indigo-100 rounded-full -left-4 ring-8 ring-white">5</span>
                        <h3 class="font-semibold text-lg"><span class="lang lang-ko">LLM í”„ë¡¬í”„íŠ¸ ìƒì„± (Prompt Generation)</span><span class="lang lang-en">Prompt Generation</span></h3>
                        <p class="text-gray-600"><span class="lang lang-ko">ê²€ìƒ‰ ê²°ê³¼ì™€ ëŒ€í™” íˆìŠ¤í† ë¦¬ë¥¼ ì¡°í•©í•´ LLMìš© í”„ë¡¬í”„íŠ¸ë¥¼ ë§Œë“­ë‹ˆë‹¤.</span><span class="lang lang-en">An LLM prompt is created by combining search results and conversation history.</span></p>
                    </li>
                    <li class="ml-6">
                        <span class="absolute flex items-center justify-center w-8 h-8 bg-indigo-100 rounded-full -left-4 ring-8 ring-white">6</span>
                        <h3 class="font-semibold text-lg"><span class="lang lang-ko">ë‹µë³€ ìƒì„± ë° ìŠ¤íŠ¸ë¦¬ë° (Answer Generation)</span><span class="lang lang-en">Answer Generation</span></h3>
                        <p class="text-gray-600"><span class="lang lang-ko">LLMì´ ìƒì„±í•˜ëŠ” ë‹µë³€ì„ ì‹¤ì‹œê°„ìœ¼ë¡œ UIì— í‘œì‹œí•©ë‹ˆë‹¤. ADKì—ì„œëŠ” `adk-chat` ì»´í¬ë„ŒíŠ¸ê°€ ì´ë¥¼ ì²˜ë¦¬í•©ë‹ˆë‹¤.</span><span class="lang lang-en">The answer generated by the LLM is streamed to the UI in real-time. In ADK, the `adk-chat` component handles this.</span></p>
                    </li>
                    <li class="ml-6">
                        <span class="absolute flex items-center justify-center w-8 h-8 bg-indigo-100 rounded-full -left-4 ring-8 ring-white">7</span>
                        <h3 class="font-semibold text-lg"><span class="lang lang-ko">ê²°ê³¼ í‘œì‹œ (Display Results)</span><span class="lang lang-en">Display Results</span></h3>
                        <p class="text-gray-600"><span class="lang lang-ko">ë‹µë³€ê³¼ í•¨ê»˜ ê²€ìƒ‰ëœ ë°ì´í„°(í…Œì´ë¸”)ë¥¼ UIì— ë Œë”ë§í•©ë‹ˆë‹¤.</span><span class="lang lang-en">The answer and the retrieved data (table) are rendered in the UI.</span></p>
                    </li>
                </ol>
            </section>

            <!-- Section 3: ì½”ë“œ êµ¬ì¡° ë° í•µì‹¬ í•¨ìˆ˜ ì„¤ëª… -->
            <section id="functions" class="card p-8">
                <h2 class="flex items-center text-2xl font-bold mb-6 border-b pb-4">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-3 text-indigo-500"><polyline points="16 18 22 12 16 6"></polyline><polyline points="8 6 2 12 8 18"></polyline></svg>
                    <span class="lang lang-ko">3. ì½”ë“œ êµ¬ì¡° ë° í•µì‹¬ í•¨ìˆ˜ ì„¤ëª…</span><span class="lang lang-en">3. Code Structure and Core Functions</span>
                </h2>
                <div class="space-y-12">
                    <div id="functions-core">
                        <h3 class="font-semibold text-xl mb-4"><span class="lang lang-ko">3.1. í•µì‹¬ í•¨ìˆ˜</span><span class="lang lang-en">3.1. Core Functions</span></h3>
                        <div class="space-y-6">
                            <div>
                                <h4 class="font-semibold text-lg"><code>retrieve_documents_as_dataframe(question)</code></h4>
                                <p class="text-gray-600"><span class="lang lang-ko">Discovery Engine APIë¥¼ í˜¸ì¶œí•˜ì—¬ ë¬¸ì„œë¥¼ ê²€ìƒ‰í•˜ê³ , ê²°ê³¼ë¥¼ 1ì‹œê°„ ë™ì•ˆ ìºì‹±í•©ë‹ˆë‹¤.</span><span class="lang lang-en">Calls the Discovery Engine API to search for documents and caches the results for 1 hour.</span></p>
                            </div>
                            <div>
                                <h4 class="font-semibold text-lg"><code>query_bigquery_by_id(doc_id)</code></h4>
                                <p class="text-gray-600"><span class="lang lang-ko">ë…¼ë¬¸ IDë¥¼ ì‚¬ìš©í•´ BigQuery í…Œì´ë¸”ì„ ì§ì ‘ ì¿¼ë¦¬í•˜ë©°, SQL ì¸ì ì…˜ì„ ë°©ì§€í•©ë‹ˆë‹¤.</span><span class="lang lang-en">Directly queries the BigQuery table using a paper ID, preventing SQL injection.</span></p>
                            </div>
                            <div>
                                <h4 class="font-semibold text-lg"><code>find_related_documents(target_doc, all_docs_df)</code></h4>
                                <p class="text-gray-600"><span class="lang lang-ko">TF-IDFì™€ ì½”ì‚¬ì¸ ìœ ì‚¬ë„ë¥¼ ê³„ì‚°í•˜ì—¬ ê¸°ì¤€ ë…¼ë¬¸ê³¼ ê°€ì¥ ìœ ì‚¬í•œ ë…¼ë¬¸ì„ ì°¾ìŠµë‹ˆë‹¤.</span><span class="lang lang-en">Finds the most similar papers to a reference paper by calculating TF-IDF and cosine similarity.</span></p>
                            </div>
                            <div>
                                <h4 class="font-semibold text-lg"><code>generate_answer_stream(question, docs)</code></h4>
                                <p class="text-gray-600"><span class="lang lang-ko">ëŒ€í™” íˆìŠ¤í† ë¦¬, ì°¸ê³  ë¬¸ì„œë¥¼ ì¡°í•©í•˜ì—¬ LLM í”„ë¡¬í”„íŠ¸ë¥¼ êµ¬ì„±í•˜ê³  ë‹µë³€ì„ ìŠ¤íŠ¸ë¦¬ë°í•©ë‹ˆë‹¤.</span><span class="lang lang-en">Constructs an LLM prompt by combining conversation history and reference documents, then streams the answer.</span></p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Full Code Section -->
                    <div id="functions-full-code" class="pt-8 border-t mt-8">
                        <h3 class="font-semibold text-xl mb-3"><span class="lang lang-ko">3.2. ì „ì²´ ì½”ë“œ (Streamlit)</span><span class="lang lang-en">3.2. Full Code (Streamlit)</span></h3>
                        <p class="text-gray-600 mb-4">
                            <span class="lang lang-ko">ì•„ë˜ëŠ” ì´ ë§¤ë‰´ì–¼ì˜ ê¸°ë°˜ì´ ë˜ëŠ” ì›ë³¸ Streamlit ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ì „ì²´ Python ì½”ë“œì…ë‹ˆë‹¤.</span>
                            <span class="lang lang-en">Below is the full Python code for the original Streamlit application that this manual is based on.</span>
                        </p>
                        <div class="relative">
<pre><code id="full-code" class="language-python">
# ì´ ì½”ë“œëŠ” Streamlit ë²„ì „ì˜ ì›ë³¸ ì½”ë“œì…ë‹ˆë‹¤.
# ADK ë²„ì „ìœ¼ë¡œì˜ ë³€í™˜ì€ ì•„ë˜ ê°€ì´ë“œë¥¼ ì°¸ê³ í•˜ì„¸ìš”.
import streamlit as st
import requests
import re
import pandas as pd
from google.auth import default, exceptions as google_auth_exceptions
from google.auth.transport.requests import Request
from google.cloud import bigquery
from langchain_google_genai import ChatGoogleGenerativeAI
import os
from sklearn.feature_extraction.text import TfidfVectorizer
from sklearn.metrics.pairwise import cosine_similarity
import logging

# ------------------------------
# ë¡œê¹… ì„¤ì •
# ------------------------------
logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')

# ------------------------------
# í™˜ê²½ ì„¤ì •
# ------------------------------
# ì¤‘ìš”: ì‹¤ì œ ìš´ì˜ í™˜ê²½ì—ì„œëŠ” API í‚¤ì™€ ê°™ì€ ë¯¼ê°í•œ ì •ë³´ë¥¼ ì½”ë“œì— ì§ì ‘ í•˜ë“œì½”ë”©í•˜ì§€ ë§ˆì„¸ìš”.
# Streamlit Secrets, í™˜ê²½ ë³€ìˆ˜, ë˜ëŠ” Google Secret Managerì™€ ê°™ì€ ì•ˆì „í•œ ë°©ë²•ì„ ì‚¬ìš©í•˜ì„¸ìš”.
os.environ["GOOGLE_API_KEY"] = "YOUR_API_KEY"
PROJECT_NUMBER = "YOUR_PROJECT_NUMBER"
ENGINE_ID = "YOUR_ENGINE_ID"
BIGQUERY_TABLE = "YOUR_PROJECT_ID.YOUR_DATASET.YOUR_TABLE"

DISCOVERY_ENDPOINT = f"https://discoveryengine.googleapis.com/v1alpha/projects/{PROJECT_NUMBER}/locations/global/collections/default_collection/engines/{ENGINE_ID}/servingConfigs/default_search:search"

llm = ChatGoogleGenerativeAI(model="gemini-2.0-flash-001", streaming=True)

# Streamlit ì„¸ì…˜ ìƒíƒœ ì´ˆê¸°í™”
if "chat_history" not in st.session_state:
    st.session_state.chat_history = []
if "last_authors" not in st.session_state:
    st.session_state.last_authors = None
if "last_doc_ids" not in st.session_state:
    st.session_state.last_doc_ids = set()
if "context_docs" not in st.session_state:
    st.session_state.context_docs = []
if "last_search_query" not in st.session_state:
    st.session_state.last_search_query = ""

# ------------------------------
# ìœ í‹¸ í•¨ìˆ˜
# ------------------------------
def extract_id(question: str):
    match = re.search(r'id[=\s:]+([a-f0-9\-]+)', question, re.IGNORECASE)
    return match.group(1) if match else None

def extract_doi_or_url(question: str):
    doi_match = re.search(r'(10\.\d{4,9}/[^\s]+)', question)
    if doi_match: return doi_match.group(1)
    url_match = re.search(r'https://(?:www\.)?biorxiv\.org/content/([^\s]+)', question)
    if url_match: return url_match.group(1)
    return None

def extract_keywords_and_years(question: str):
    years = re.findall(r'(19|20)\d{2}', question)
    year = years[0] if years else None
    words = re.findall(r'\b([A-Z][a-zA-Z\-\'.]+(?:\s[A-Z][a-zA-Z\-\'.]+)*)\b', question)
    keyword = " ".join(words) if words else None
    return keyword, year

def extract_keywords_from_question(question: str) -> str:
    keywords = re.findall(r'\b\w+\b', question)
    return " ".join([word for word in keywords if len(word) > 2])

# ------------------------------
# í•„í„° í•¨ìˆ˜
# ------------------------------
def filter_relevant_documents(df: pd.DataFrame, question: str) -> pd.DataFrame:
    logging.info(f"í•„í„°ë§ ì‹œì‘. ì…ë ¥ í–‰ ê°œìˆ˜: {len(df)}")
    if df.empty: return pd.DataFrame()

    keyword, year = extract_keywords_and_years(question)
    
    if not keyword and not year: return df

    def row_matches(row):
        keyword_match = True
        if keyword:
            keyword_match = any(keyword.lower() in str(row.get(col, "")).lower() for col in ["title", "abstract", "authors"])
        
        year_match = True
        if year:
            year_match = str(year) in str(row.get("date", ""))
            
        return keyword_match and year_match

    return df[df.apply(row_matches, axis=1)]

# ------------------------------
# ê²€ìƒ‰ í•¨ìˆ˜
# ------------------------------
@st.cache_data(ttl=3600)
def retrieve_documents_as_dataframe(question: str, top_k: int = 20):
    logging.info(f"Discovery Engine ê²€ìƒ‰: '{question}'")
    try:
        credentials, _ = default(scopes=["https://www.googleapis.com/auth/cloud-platform"])
        credentials.refresh(Request())
    except Exception as e:
        st.error(f"âŒ Google Cloud ì¸ì¦ ì‹¤íŒ¨: {e}")
        return pd.DataFrame()

    headers = {"Authorization": f"Bearer {credentials.token}", "Content-Type": "application/json"}
    body = {
        "pageSize": top_k,
        "query": question,
        "languageCode": "ko",
        "queryExpansionSpec": {"condition": "AUTO"},
        "spellCorrectionSpec": {"mode": "AUTO"}
    }

    try:
        response = requests.post(DISCOVERY_ENDPOINT, headers=headers, json=body)
        response.raise_for_status()
        data = response.json()
        rows = [doc.get("document", {}).get("structData", {}) for doc in data.get("results", [])]
        logging.info(f"Discovery Engine ê²€ìƒ‰ ì„±ê³µ. ê²°ê³¼ {len(rows)}ê°œ")
        return pd.DataFrame(rows)
    except requests.exceptions.RequestException as e:
        st.error(f"âŒ Discovery Engine ê²€ìƒ‰ ì‹¤íŒ¨: {e}")
        return pd.DataFrame()

# ------------------------------
# BigQuery ì§ì ‘ ì¿¼ë¦¬ í•¨ìˆ˜
# ------------------------------
@st.cache_data(ttl=3600)
def query_bigquery_by_id(doc_id: str) -> pd.DataFrame:
    logging.info(f"BigQuery ì¿¼ë¦¬: ID='{doc_id}'")
    try:
        bq_client = bigquery.Client()
        query = f"SELECT * FROM `{BIGQUERY_TABLE}` WHERE id = @doc_id"
        job_config = bigquery.QueryJobConfig(query_parameters=[bigquery.ScalarQueryParameter("doc_id", "STRING", doc_id)])
        return bq_client.query(query, job_config=job_config).to_dataframe()
    except Exception as e:
        st.error(f"âŒ BigQuery ì¿¼ë¦¬ ì˜¤ë¥˜: {e}")
        return pd.DataFrame()

# ------------------------------
# ê´€ë ¨ ë…¼ë¬¸ ì°¾ê¸° í•¨ìˆ˜
# ------------------------------
def preprocess_text(text):
    return re.sub(r'[^\w\s]', '', str(text)).lower() if text else ""

def find_related_documents(target_doc, all_docs_df: pd.DataFrame, top_k=5):
    if target_doc is None or all_docs_df.empty: return pd.DataFrame()

    all_docs_df["combined_text"] = all_docs_df["title"].fillna("") + " " + all_docs_df["abstract"].fillna("")
    all_docs_df["combined_text"] = all_docs_df["combined_text"].apply(preprocess_text)
    target_text = preprocess_text(target_doc.get("title", "") + " " + target_doc.get("abstract", ""))
    
    tfidf = TfidfVectorizer()
    all_docs_tfidf = tfidf.fit_transform(all_docs_df["combined_text"])
    target_tfidf = tfidf.transform([target_text])
    
    similarities = cosine_similarity(target_tfidf, all_docs_tfidf).flatten()
    related_indices = similarities.argsort()[::-1]
    related_indices = [i for i in related_indices if all_docs_df.iloc[i].get("id") != target_doc.get("id")]
    
    return all_docs_df.iloc[related_indices[:top_k]]

# ------------------------------
# ë³µí•© ì§ˆì˜ ì²˜ë¦¬ í•¨ìˆ˜
# ------------------------------
def handle_complex_query(question: str, context_df: pd.DataFrame) -> pd.DataFrame:
    if "ê´€ë ¨ëœ ë…¼ë¬¸" in question.lower() and not context_df.empty:
        target_doc = context_df.iloc[0].to_dict()
        search_query = target_doc.get("title", "")
        all_docs_df = retrieve_documents_as_dataframe(search_query)
        return find_related_documents(target_doc, all_docs_df)
    
    return filter_relevant_documents(context_df, question)

# ------------------------------
# LLM ì‘ë‹µ ìƒì„±
# ------------------------------
def generate_answer_stream(question: str, docs: list):
    context = "\n\n---\n\n".join([str(doc) for doc in docs])
    history = "\n".join([f"Q: {turn['question']}\nA: {turn['answer']}" for turn in st.session_state.chat_history])
    prompt = f"""
ëŒ€í™” ê¸°ë¡:
{history}

ì°¸ê³  ë¬¸ì„œ:
{context}

ìœ„ ëŒ€í™” ê¸°ë¡ê³¼ ì°¸ê³  ë¬¸ì„œë¥¼ ë°”íƒ•ìœ¼ë¡œ ë‹¤ìŒ ì§ˆë¬¸ì— ëŒ€í•´ ìƒì„¸í•˜ê³  ì¹œì ˆí•˜ê²Œ ë‹µë³€í•´ ì£¼ì„¸ìš”.
ì§ˆë¬¸: {question}
ë‹µë³€:
"""
    with st.chat_message("assistant"):
        message_placeholder = st.empty()
        full_response = ""
        for chunk in llm.stream(prompt):
            full_response += chunk.content
            message_placeholder.markdown(full_response + "â–Œ")
        message_placeholder.markdown(full_response)
    return full_response

# ------------------------------
# Streamlit UI
# ------------------------------
st.set_page_config(page_title="QA (Discovery Engine)", layout="wide")
st.title("ğŸ” VertexAI ê¸°ë°˜ BigQuery QA")
question_input = st.text_input("ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”", placeholder="ì˜ˆ: ë…¼ë¬¸ ID, ì €ì, í‚¤ì›Œë“œ ë“±ìœ¼ë¡œ ê²€ìƒ‰")

if question_input:
    with st.spinner("ğŸ” ê²€ìƒ‰ ë° LLM ë¶„ì„ ì¤‘..."):
        extracted_id = extract_id(question_input)
        is_complex = st.session_state.chat_history and any(k in question_input.lower() for k in ["ë‹¤ë¥¸", "ê´€ë ¨ëœ"])

        if extracted_id:
            filtered_df = query_bigquery_by_id(extracted_id)
        elif is_complex:
            context_df = pd.DataFrame(st.session_state.context_docs)
            filtered_df = handle_complex_query(question_input, context_df)
        else:
            df = retrieve_documents_as_dataframe(question_input)
            filtered_df = filter_relevant_documents(df, question_input)
            st.session_state.last_search_query = question_input
        
        if not filtered_df.empty:
            st.session_state.context_docs = filtered_df.to_dict('records')
        
        docs = st.session_state.context_docs
        with st.chat_message("user"):
            st.markdown(question_input)
        
        answer = generate_answer_stream(question_input, docs)
        st.session_state.chat_history.append({"question": question_input, "answer": answer, "df": filtered_df})

# ëŒ€í™” íˆìŠ¤í† ë¦¬ í‘œì‹œ
if st.session_state.chat_history:
    st.subheader("ğŸ’¬ ëŒ€í™” íˆìŠ¤í† ë¦¬")
    for i, turn in enumerate(reversed(st.session_state.chat_history)):
        with st.expander(f"#{len(st.session_state.chat_history)-i} {turn['question'][:60]}..."):
            with st.chat_message("user"): st.markdown(turn["question"])
            with st.chat_message("assistant"): st.markdown(turn['answer'])
            
            df = turn.get("df")
            if df is not None and not df.empty:
                st.markdown("#### ğŸ“Š ê²€ìƒ‰ ê²°ê³¼")
                st.dataframe(df, use_container_width=True)
</code></pre>
                        </div>
                    </div>

                    <!-- ADK Conversion Guide Section -->
                    <div id="functions-adk-guide" class="pt-8 border-t mt-8">
                        <h3 class="font-semibold text-xl mb-3"><span class="lang lang-ko">3.3. Streamlitì—ì„œ Google Agent Development Kit (ADK)ìœ¼ë¡œ ì „í™˜ ê°€ì´ë“œ</span><span class="lang lang-en">3.3. Guide: Converting from Streamlit to Google Agent Development Kit (ADK)</span></h3>
                        <p class="text-gray-600 mb-4">
                            <span class="lang lang-ko">Streamlitì€ ë¹ ë¥¸ í”„ë¡œí† íƒ€ì´í•‘ì— ë§¤ìš° ìœ ìš©í•˜ì§€ë§Œ, Google ADKëŠ” ì—ì´ì „íŠ¸ì˜ í•µì‹¬ ë¡œì§ê³¼ UIë¥¼ ë¶„ë¦¬í•˜ê³ , ë„êµ¬(Tool) ê¸°ë°˜ì˜ ì•„í‚¤í…ì²˜ë¥¼ ì ìš©í•˜ì—¬ ë” êµ¬ì¡°ì ì´ê³  í™•ì¥ ê°€ëŠ¥í•œ ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ë§Œë“¤ ìˆ˜ ìˆê²Œ í•´ì¤ë‹ˆë‹¤. ADKëŠ” íŠ¹íˆ Google Cloud ì„œë¹„ìŠ¤ì™€ì˜ ê¸´ë°€í•œ í†µí•© ë° ë°°í¬ë¥¼ ì—¼ë‘ì— ë‘ê³  ì„¤ê³„ë˜ì—ˆìŠµë‹ˆë‹¤.</span>
                            <span class="lang lang-en">While Streamlit is excellent for rapid prototyping, Google ADK allows for more structured and scalable applications by separating the agent's core logic from the UI and applying a tool-based architecture. ADK is designed with close integration and deployment with Google Cloud services in mind.</span>
                        </p>
                        <p class="text-gray-600 mb-6">
                            <span class="lang lang-ko">ì´ ê°€ì´ë“œì—ì„œëŠ” ê¸°ì¡´ Streamlit ì½”ë“œì˜ í•µì‹¬ ê¸°ëŠ¥ì„ ADKì˜ êµ¬ì¡°ì— ë§ê²Œ ì¬êµ¬ì„±í•˜ì—¬ ì›¹ ê¸°ë°˜ ì±„íŒ… ì—ì´ì „íŠ¸ë¡œ ì‹¤í–‰í•˜ëŠ” ë°©ë²•ì„ ì„¤ëª…í•©ë‹ˆë‹¤.</span>
                            <span class="lang lang-en">This guide explains how to refactor the core functionality of the existing Streamlit code to fit ADK's structure and run it as a web-based chat agent.</span>
                        </p>

                        <div class="space-y-8">
                            <div>
                                <h4 class="font-semibold text-lg mb-3"><span class="lang lang-ko">1ë‹¨ê³„: í”„ë¡œì íŠ¸ êµ¬ì¡° ì„¤ì • ë° ì„¤ì¹˜</span><span class="lang lang-en">Step 1: Project Setup and Installation</span></h4>
                                <p class="text-gray-600 mb-4">
                                    <span class="lang lang-ko">ADK í”„ë¡œì íŠ¸ëŠ” ì¼ë°˜ì ìœ¼ë¡œ ì—ì´ì „íŠ¸ ë¡œì§, ì›¹ í”„ë¡ íŠ¸ì—”ë“œ, ì‹¤í–‰ ìŠ¤í¬ë¦½íŠ¸ë¡œ êµ¬ì„±ë©ë‹ˆë‹¤. ë¨¼ì € í•„ìš”í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì„¤ì¹˜í•©ë‹ˆë‹¤.</span>
                                    <span class="lang lang-en">An ADK project typically consists of agent logic, a web frontend, and an execution script. First, install the necessary libraries.</span>
                                </p>
                                <div class="relative">
                                    <pre><code class="language-bash">
# google-adkì™€ í•¨ê»˜ í•„ìš”í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬ë“¤ì„ ì„¤ì¹˜í•©ë‹ˆë‹¤.
# Install the required libraries along with google-adk.
pip install google-adk langchain-google-genai google-cloud-bigquery pandas scikit-learn
                                    </code></pre>
                                </div>
                                <p class="text-gray-600 mt-4">
                                    <span class="lang lang-ko">ì•„ë˜ì™€ ê°™ì´ í”„ë¡œì íŠ¸ íŒŒì¼ êµ¬ì¡°ë¥¼ ë§Œë“­ë‹ˆë‹¤.</span>
                                    <span class="lang lang-en">Create the project file structure as shown below.</span>
                                </p>
                                <div class="relative">
                                    <pre><code class="language-bash">
your-adk-project/
â”œâ”€â”€ agent.py         # ì—ì´ì „íŠ¸ì˜ í•µì‹¬ ë¡œì§ ë° ë„êµ¬ ì •ì˜ (Agent's core logic and tool definitions)
â”œâ”€â”€ main.py          # ADK ì›¹ ì„œë²„ ì‹¤í–‰ (Run the ADK web server)
â””â”€â”€ static/
    â””â”€â”€ index.html   # ì›¹ í”„ë¡ íŠ¸ì—”ë“œ UI (Web frontend UI)
                                    </code></pre>
                                </div>
                            </div>

                            <div>
                                <h4 class="font-semibold text-lg mb-3"><span class="lang lang-ko">2ë‹¨ê³„: ì—ì´ì „íŠ¸ ë° ë„êµ¬ ì •ì˜ (`agent.py`)</span><span class="lang lang-en">Step 2: Define Agent and Tools (`agent.py`)</span></h4>
                                <p class="text-gray-600 mb-4">
                                    <span class="lang lang-ko">ê¸°ì¡´ Streamlitì˜ í•¨ìˆ˜ë“¤ì„ ADKê°€ ì¸ì‹í•  ìˆ˜ ìˆëŠ” 'ë„êµ¬(Tool)'ë¡œ ë³€í™˜í•©ë‹ˆë‹¤. `@tool` ë°ì½”ë ˆì´í„°ë¥¼ ì‚¬ìš©í•˜ì—¬ ê° í•¨ìˆ˜ë¥¼ ë˜í•‘í•˜ê³ , ì´ ë„êµ¬ë“¤ì„ ì‚¬ìš©í•˜ëŠ” ì—ì´ì „íŠ¸ í´ë˜ìŠ¤ë¥¼ ì •ì˜í•©ë‹ˆë‹¤.</span>
                                    <span class="lang lang-en">Convert the functions from the Streamlit code into 'Tools' that ADK can recognize. Wrap each function with the `@tool` decorator and define an agent class that uses these tools.</span>
                                </p>
                                <div class="relative">
                                    <pre><code class="language-python">
# agent.py

import os
import re
import pandas as pd
import requests
from google.auth import default
from google.auth.transport.requests import Request
from google.cloud import bigquery
from langchain_google_genai import ChatGoogleGenerativeAI
from sklearn.feature_extraction.text import TfidfVectorizer
from sklearn.metrics.pairwise import cosine_similarity
from adk.api import*

# --- í™˜ê²½ ë³€ìˆ˜ ì„¤ì • (Set Environment Variables) ---
# ì‹¤ì œ ìš´ì˜ í™˜ê²½ì—ì„œëŠ” Secret Manager ì‚¬ìš©ì„ ê¶Œì¥í•©ë‹ˆë‹¤. (Using Secret Manager is recommended in production)
os.environ["GOOGLE_API_KEY"] = "YOUR_API_KEY"
PROJECT_NUMBER = "YOUR_PROJECT_NUMBER"
ENGINE_ID = "YOUR_ENGINE_ID"
BIGQUERY_TABLE = "YOUR_PROJECT_ID.YOUR_DATASET.YOUR_TABLE"
DISCOVERY_ENDPOINT = f"https://discoveryengine.googleapis.com/v1alpha/projects/{PROJECT_NUMBER}/locations/global/collections/default_collection/engines/{ENGINE_ID}/servingConfigs/default_search:search"

# --- ê¸°ì¡´ í•¨ìˆ˜ë¥¼ ADK ë„êµ¬ë¡œ ë³€í™˜ (Convert existing functions to ADK tools) ---

@tool
def search_papers_with_discovery_engine(query: str) -> str:
    """
    ì‚¬ìš©ìì˜ ìì—°ì–´ ì§ˆë¬¸ì„ ê¸°ë°˜ìœ¼ë¡œ Discovery Engineì„ ì‚¬ìš©í•´ ê´€ë ¨ ë…¼ë¬¸ì„ ê²€ìƒ‰í•©ë‹ˆë‹¤.
    ì¼ë°˜ì ì¸ ì§ˆë¬¸, ì£¼ì œ, í‚¤ì›Œë“œ ê²€ìƒ‰ì— ì‚¬ìš©ë©ë‹ˆë‹¤.
    ê²°ê³¼ëŠ” Markdown í…Œì´ë¸” í˜•ì‹ì˜ ë¬¸ìì—´ë¡œ ë°˜í™˜ë©ë‹ˆë‹¤.
    (Searches for relevant papers using Discovery Engine based on the user's natural language query.
    Used for general questions, topics, and keyword searches.
    The result is returned as a Markdown table string.)
    """
    # ... (ê¸°ì¡´ retrieve_documents_as_dataframe í•¨ìˆ˜ì˜ ë¡œì§) ...
    # ì¸ì¦ ë° API í˜¸ì¶œ ë¡œì§ì€ ë™ì¼ (Authentication and API call logic remains the same)
    try:
        credentials, _ = default(scopes=["https://www.googleapis.com/auth/cloud-platform"])
        credentials.refresh(Request())
        headers = {"Authorization": f"Bearer {credentials.token}", "Content-Type": "application/json"}
        body = {"pageSize": 10, "query": query, "languageCode": "ko"}
        response = requests.post(DISCOVERY_ENDPOINT, headers=headers, json=body)
        response.raise_for_status()
        data = response.json()
        rows = [doc.get("document", {}).get("structData", {}) for doc in data.get("results", [])]
        if not rows:
            return "ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤. (No search results found.)"
        df = pd.DataFrame(rows)[['id', 'title', 'authors']].head(5)
        return df.to_markdown()
    except Exception as e:
        return f"Discovery Engine ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ ë°œìƒ (Error during Discovery Engine search): {e}"

@tool
def get_paper_details_by_id(paper_id: str) -> str:
    """
    ì •í™•í•œ ë…¼ë¬¸ IDë¥¼ ì‚¬ìš©í•˜ì—¬ BigQueryì—ì„œ ë…¼ë¬¸ì˜ ìƒì„¸ ì •ë³´ë¥¼ ì¡°íšŒí•©ë‹ˆë‹¤.
    ì‚¬ìš©ìê°€ 'id'ë‚˜ íŠ¹ì • ID í˜•ì‹ì„ ì–¸ê¸‰í•  ë•Œ ì‚¬ìš©í•©ë‹ˆë‹¤.
    ê²°ê³¼ëŠ” Markdown í…Œì´ë¸” í˜•ì‹ì˜ ë¬¸ìì—´ë¡œ ë°˜í™˜ë©ë‹ˆë‹¤.
    (Retrieves detailed information for a paper from BigQuery using its exact ID.
    Used when the user mentions 'id' or a specific ID format.
    The result is returned as a Markdown table string.)
    """
    # ... (ê¸°ì¡´ query_bigquery_by_id í•¨ìˆ˜ì˜ ë¡œì§) ...
    try:
        bq_client = bigquery.Client()
        query = f"SELECT id, title, abstract, authors, date FROM `{BIGQUERY_TABLE}` WHERE id = @doc_id"
        job_config = bigquery.QueryJobConfig(query_parameters=[bigquery.ScalarQueryParameter("doc_id", "STRING", paper_id)])
        df = bq_client.query(query, job_config=job_config).to_dataframe()
        if df.empty:
            return f"ID '{paper_id}'ì— í•´ë‹¹í•˜ëŠ” ë…¼ë¬¸ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (Paper with ID '{paper_id}' not found.)"
        return df.to_markdown()
    except Exception as e:
        return f"BigQuery ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ ë°œìƒ (Error during BigQuery query): {e}"

# --- ì—ì´ì „íŠ¸ ì •ì˜ (Define Agent) ---
class PaperQaAgent(Agent):
    def __call__(self, query: str, history: History) -> Message:
        """ì‚¬ìš©ì ì§ˆë¬¸ì— ë‹µë³€í•˜ëŠ” ë…¼ë¬¸ ê²€ìƒ‰ ì—ì´ì „íŠ¸ (A paper search agent that answers user questions)"""
        
        # LLMì´ ë„êµ¬ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ ì„¤ì • (Set system prompt for the LLM to use tools)
        prompt = f"""
You are an AI assistant with access to a research paper database.
Analyze the user's intent and use the most appropriate tool.
- For general keywords, topics, or author names, use 'search_papers_with_discovery_engine'.
- For questions containing the word 'id' or a clear ID format (e.g., a1b2c3d4), use 'get_paper_details_by_id'.

Conversation History:
{history.format()}

User Question: {query}
"""
        llm = ChatGoogleGenerativeAI(model="gemini-2.0-flash-001", convert_system_message_to_human=True)
        
        # LLMì´ ë„êµ¬ ì‚¬ìš©ì„ í¬í•¨í•œ ë‹µë³€ì„ ìƒì„±í•˜ë„ë¡ í˜¸ì¶œ (Invoke the LLM to generate a response, including tool use)
        response = llm.invoke(prompt, tools=[search_papers_with_discovery_engine, get_paper_details_by_id])
        
        return Message(content=response.content, tool_calls=response.tool_calls)

                                    </code></pre>
                                </div>
                            </div>

                            <div>
                                <h4 class="font-semibold text-lg mb-3"><span class="lang lang-ko">3ë‹¨ê³„: ì›¹ í”„ë¡ íŠ¸ì—”ë“œ ìƒì„± (`static/index.html`)</span><span class="lang lang-en">Step 3: Create Web Frontend (`static/index.html`)</span></h4>
                                <p class="text-gray-600 mb-4">
                                    <span class="lang lang-ko">ADKê°€ ì œê³µí•˜ëŠ” `adk-chat` ì›¹ ì»´í¬ë„ŒíŠ¸ë¥¼ ì‚¬ìš©í•˜ì—¬ ë§¤ìš° ê°„ë‹¨í•˜ê²Œ ì±„íŒ… UIë¥¼ ë§Œë“¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ ì»´í¬ë„ŒíŠ¸ëŠ” ë°±ì—”ë“œ ì—ì´ì „íŠ¸ì™€ì˜ í†µì‹ , ëŒ€í™” ê¸°ë¡ ê´€ë¦¬, ìŠ¤íŠ¸ë¦¬ë° ì‘ë‹µ í‘œì‹œ, Markdown ë Œë”ë§ ë“±ì„ ìë™ìœ¼ë¡œ ì²˜ë¦¬í•©ë‹ˆë‹¤.</span>
                                    <span class="lang lang-en">You can easily create a chat UI using the `adk-chat` web component provided by ADK. This component automatically handles communication with the backend agent, conversation history management, streaming response display, Markdown rendering, and more.</span>
                                </p>
                                <div class="relative">
                                    <pre><code class="language-html">
<!-- static/index.html -->
<!DOCTYPE html>
<html>
  <head>
    <title>ADK-based Paper QA System</title>
    <script
      type="module"
      src="https://storage.googleapis.com/adk-web-components/adk-web-components-v0.1.0.js"
    ></script>
    <style>
      body, html { margin: 0; padding: 0; height: 100%; font-family: 'Noto Sans KR', sans-serif; }
      adk-chat {
        --adk-chat-prompt-input-placeholder: 'Ask about papers by ID, author, keyword...';
        --adk-chat-header-text: 'Paper QA Agent';
        --adk-font-family: "'Noto Sans KR', sans-serif";
      }
    </style>
  </head>
  <body>
    <adk-chat server="http://127.0.0.1:8080"></adk-chat>
  </body>
</html>
                                    </code></pre>
                                </div>
                            </div>
                            
                            <div>
                                <h4 class="font-semibold text-lg mb-3"><span class="lang lang-ko">4ë‹¨ê³„: ADK ì„œë²„ ì‹¤í–‰ (`main.py`)</span><span class="lang lang-en">Step 4: Run ADK Server (`main.py`)</span></h4>
                                <p class="text-gray-600 mb-4">
                                    <span class="lang lang-ko">`agent.py`ì—ì„œ ì •ì˜í•œ ì—ì´ì „íŠ¸ì™€ `static` í´ë”ì˜ ì›¹ í”„ë¡ íŠ¸ì—”ë“œë¥¼ ì—°ê²°í•˜ì—¬ ì„œë²„ë¥¼ ì‹¤í–‰í•˜ëŠ” ìŠ¤í¬ë¦½íŠ¸ì…ë‹ˆë‹¤.</span>
                                    <span class="lang lang-en">This script runs the server, connecting the agent defined in `agent.py` with the web frontend in the `static` folder.</span>
                                </p>
                                <div class="relative">
                                    <pre><code class="language-python">
# main.py

from adk.web import start_server
from agent import PaperQaAgent

if __name__ == "__main__":
    start_server(PaperQaAgent, "static")
                                    </code></pre>
                                </div>
                            </div>

                            <div>
                                <h4 class="font-semibold text-lg mb-3"><span class="lang lang-ko">5ë‹¨ê³„: ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰</span><span class="lang lang-en">Step 5: Run the Application</span></h4>
                                <p class="text-gray-600 mb-4">
                                    <span class="lang lang-ko">ëª¨ë“  íŒŒì¼ì´ ì¤€ë¹„ë˜ì—ˆìœ¼ë©´, í„°ë¯¸ë„ì—ì„œ `main.py`ë¥¼ ì‹¤í–‰í•˜ì—¬ ADK ì›¹ ì„œë²„ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤.</span>
                                    <span class="lang lang-en">Once all files are ready, run `main.py` from the terminal to start the ADK web server.</span>
                                </p>
                                <div class="relative">
                                    <pre><code class="language-bash">
python main.py
                                    </code></pre>
                                </div>
                                <p class="text-gray-600 mt-4">
                                    <span class="lang lang-ko">ì„œë²„ê°€ ì‹¤í–‰ë˜ë©´ í„°ë¯¸ë„ì— í‘œì‹œëœ ì£¼ì†Œ(ê¸°ë³¸ê°’: http://127.0.0.1:8080)ë¡œ ì ‘ì†í•˜ì—¬ ì±„íŒ… ì—ì´ì „íŠ¸ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</span>
                                    <span class="lang lang-en">When the server is running, you can access the chat agent by navigating to the address shown in the terminal (default: http://127.0.0.1:8080).</span>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Section 4: ì‹¤í–‰ ë°©ë²• -->
            <section id="execution" class="card p-8">
                <h2 class="flex items-center text-2xl font-bold mb-6 border-b pb-4">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-3 text-indigo-500"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.72"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.72-1.72"></path></svg>
                    <span class="lang lang-ko">4. ì‹¤í–‰ ë°©ë²•</span><span class="lang lang-en">4. Execution Guide</span>
                </h2>
                
                <div class="space-y-8">
                    <div>
                        <h3 id="execution-data-prep" class="font-semibold text-xl mb-3"><span class="lang lang-ko">4.1. BigQuery ë°ì´í„° ì¤€ë¹„ (GCSë¥¼ í†µí•œ ë§ˆì´ê·¸ë ˆì´ì…˜)</span><span class="lang lang-en">4.1. BigQuery Data Preparation (Migration via GCS)</span></h3>
                        <p class="text-gray-600 mb-4">
                            <span class="lang lang-ko">ì´ ì• í”Œë¦¬ì¼€ì´ì…˜ì€ BigQuery ë°ì´í„°ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤. ì‹¤ìŠµì„ ìœ„í•´ ê¸°ì¡´ í”„ë¡œì íŠ¸(`YOUR_SOURCE_PROJECT_ID`)ì˜ `ds_test` ë°ì´í„°ì…‹ì„ Google Cloud Storage(GCS)ë¡œ ë‚´ë³´ë‚¸ í›„, ì—¬ëŸ¬ë¶„ì˜ ì‹ ê·œ í”„ë¡œì íŠ¸ì— ë¡œë“œí•˜ëŠ” ê³¼ì •ì„ ì•ˆë‚´í•©ë‹ˆë‹¤.</span>
                            <span class="lang lang-en">This application uses BigQuery data. For this lab, we will guide you through exporting the `ds_test` dataset from an existing project (`YOUR_SOURCE_PROJECT_ID`) to Google Cloud Storage (GCS) and then loading it into your new project.</span>
                        </p>
                        
                        <div class="mt-6 border-t pt-6">
                            <h4 class="font-semibold text-lg mb-3"><span class="lang lang-ko">1ë‹¨ê³„: ì†ŒìŠ¤ ë°ì´í„°ì…‹ì„ GCSë¡œ ë‚´ë³´ë‚´ê¸° (Export)</span><span class="lang lang-en">Step 1: Export Source Dataset to GCS (Export)</span></h4>
                            <p class="text-gray-600 mb-4">
                                <span class="lang lang-ko">ì•„ë˜ BigQuery ìŠ¤í¬ë¦½íŠ¸ëŠ” `YOUR_SOURCE_PROJECT_ID` í”„ë¡œì íŠ¸ì˜ `ds_test` ë°ì´í„°ì…‹ì— ìˆëŠ” ëª¨ë“  í…Œì´ë¸”ì„ GCS ë²„í‚·(`gs://YOUR_BUCKET_NAME/ds_test/`)ìœ¼ë¡œ ë‚´ë³´ëƒ…ë‹ˆë‹¤. ì´ ìŠ¤í¬ë¦½íŠ¸ëŠ” CSVë¡œ ì§ì ‘ ë‚´ë³´ë‚¼ ìˆ˜ ì—†ëŠ” ARRAY ê°™ì€ ë³µì¡í•œ ë°ì´í„° íƒ€ì…ì„ ê°€ì§„ ì—´ì„ ìë™ìœ¼ë¡œ ì œì™¸í•˜ì—¬ ì˜¤ë¥˜ë¥¼ ë°©ì§€í•©ë‹ˆë‹¤.</span>
                                <span class="lang lang-en">The BigQuery script below exports all tables from the `ds_test` dataset in the `YOUR_SOURCE_PROJECT_ID` project to a GCS bucket (`gs://YOUR_BUCKET_NAME/ds_test/`). This script automatically excludes columns with complex data types like ARRAY that cannot be directly exported to CSV, preventing errors.</span>
                                <br>
                                <strong><span class="lang lang-ko">ì†ŒìŠ¤ í”„ë¡œì íŠ¸(`YOUR_SOURCE_PROJECT_ID`)ì˜ BigQuery ì½˜ì†”ì—ì„œ ì•„ë˜ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‹¤í–‰í•˜ì„¸ìš”.</span><span class="lang lang-en">Run the script below in the BigQuery console of your source project (`YOUR_SOURCE_PROJECT_ID`).</span></strong>
                            </p>
                             <div class="relative">
                                <pre><code id="bq-export-command" class="language-sql">
-- BigQuery ìŠ¤í¬ë¦½íŒ…ì„ ì‚¬ìš©í•˜ì—¬ ds_test ë°ì´í„°ì…‹ì˜ ëª¨ë“  í…Œì´ë¸”ì„ GCSë¡œ ë‚´ë³´ëƒ…ë‹ˆë‹¤.
-- ì´ ìŠ¤í¬ë¦½íŠ¸ëŠ” ì†ŒìŠ¤ í”„ë¡œì íŠ¸(YOUR_SOURCE_PROJECT_ID)ì˜ BigQuery ì½˜ì†”ì—ì„œ ì‹¤í–‰í•´ì•¼ í•©ë‹ˆë‹¤.

-- 1. ë‚´ë³´ë‚¼ í…Œì´ë¸” ëª©ë¡ì„ ë‹´ì„ ë³€ìˆ˜ë¥¼ ì„ ì–¸í•©ë‹ˆë‹¤.
DECLARE tables_to_export ARRAY<STRUCT<table_name STRING>>;
-- 2. ë£¨í”„ì—ì„œ ì‚¬ìš©í•  ë³€ìˆ˜ë“¤ì„ ì„ ì–¸í•©ë‹ˆë‹¤.
DECLARE table_name, column_names STRING;

-- 3. ds_test ë°ì´í„°ì…‹ì— ìˆëŠ” ëª¨ë“  'BASE TABLE'ì˜ ì´ë¦„ì„ ê°€ì ¸ì™€ ë³€ìˆ˜ì— í• ë‹¹í•©ë‹ˆë‹¤.
SET tables_to_export = (
  SELECT ARRAY_AGG(STRUCT(t.table_name))
  FROM `YOUR_SOURCE_PROJECT_ID.ds_test.INFORMATION_SCHEMA.TABLES` AS t
  WHERE t.table_type = 'BASE TABLE'
);

-- 4. ê° í…Œì´ë¸”ì— ëŒ€í•´ ë£¨í”„ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤.
FOR tbl_row IN (SELECT * FROM UNNEST(tables_to_export)) DO
  SET table_name = tbl_row.table_name;

  -- 5. CSVë¡œ ì§ì ‘ ë‚´ë³´ë‚¼ ìˆ˜ ì—†ëŠ” ARRAY íƒ€ì…ì„ ì œì™¸í•˜ê³ , ëª¨ë“  ì»¬ëŸ¼ ì´ë¦„ì„ ë™ì ìœ¼ë¡œ êµ¬ì„±í•©ë‹ˆë‹¤.
  SET column_names = (
    SELECT STRING_AGG(c.column_name, ', ')
    FROM `YOUR_SOURCE_PROJECT_ID.ds_test.INFORMATION_SCHEMA.COLUMNS` AS c
    WHERE c.table_name = table_name
      AND NOT STARTS_WITH(c.data_type, 'ARRAY')
  );

  -- 6. ë™ì ìœ¼ë¡œ ìƒì„±ëœ ì»¬ëŸ¼ ëª©ë¡ì„ ì‚¬ìš©í•˜ì—¬ EXPORT DATA ì¿¼ë¦¬ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤.
  -- ê° í…Œì´ë¸”ì€ GCS ë²„í‚· 'gs://YOUR_BUCKET_NAME/ds_test/'ì— 'í…Œì´ë¸”ëª…-*.csv' í˜•ì‹ìœ¼ë¡œ ì €ì¥ë©ë‹ˆë‹¤.
  EXECUTE IMMEDIATE FORMAT("""
    EXPORT DATA OPTIONS(
      uri='gs://YOUR_BUCKET_NAME/ds_test/%s-*.csv',
      format='CSV',
      header=true,
      overwrite=true
    ) AS
    SELECT %s
    FROM `YOUR_SOURCE_PROJECT_ID.ds_test`.`%s`;
  """, table_name, column_names, table_name);

END FOR;
</code></pre>
                            </div>
                        </div>

                        <div class="mt-8 border-t pt-6">
                            <h4 class="font-semibold text-lg mb-3"><span class="lang lang-ko">2ë‹¨ê³„: GCSì˜ CSV íŒŒì¼ì„ ìƒˆ í”„ë¡œì íŠ¸ì˜ BigQueryë¡œ ë¡œë“œí•˜ê¸° (Load)</span><span class="lang lang-en">Step 2: Load CSV files from GCS to BigQuery in the New Project (Load)</span></h4>
                            <p class="text-gray-600 mb-4">
                                <span class="lang lang-ko">1ë‹¨ê³„ê°€ ì™„ë£Œë˜ì–´ GCSì— CSV íŒŒì¼ë“¤ì´ ì €ì¥ë˜ì—ˆë‹¤ë©´, ì´ì œ <strong>ì—¬ëŸ¬ë¶„ì˜ ìƒˆë¡œìš´ Google Cloud í”„ë¡œì íŠ¸</strong>ì—ì„œ ì•„ë˜ ì ˆì°¨ì— ë”°ë¼ ë°ì´í„°ë¥¼ BigQueryë¡œ ê°€ì ¸ì˜µë‹ˆë‹¤.</span>
                                <span class="lang lang-en">Once Step 1 is complete and the CSV files are in GCS, follow the steps below in <strong>your new Google Cloud project</strong> to import the data into BigQuery.</span>
                            </p>
                            <ol class="list-decimal list-inside space-y-4 text-gray-600">
                                <li>
                                    <strong><span class="lang lang-ko">ë°ì´í„°ì„¸íŠ¸ ìƒì„±:</span><span class="lang lang-en">Create a Dataset:</span></strong>
                                    <ul class="list-disc list-inside ml-4 mt-2 space-y-1">
                                        <li><span class="lang lang-ko">ìƒˆ í”„ë¡œì íŠ¸ì˜ BigQuery Studioë¡œ ì´ë™í•©ë‹ˆë‹¤.</span><span class="lang lang-en">Go to the BigQuery Studio in your new project.</span></li>
                                        <li><span class="lang lang-ko">íƒìƒ‰ê¸° íŒ¨ë„ì—ì„œ í”„ë¡œì íŠ¸ ID ì˜†ì˜ ì  3ê°œ ì•„ì´ì½˜(â‹®)ì„ í´ë¦­í•˜ê³  'ë°ì´í„°ì„¸íŠ¸ ë§Œë“¤ê¸°'ë¥¼ ì„ íƒí•©ë‹ˆë‹¤.</span><span class="lang lang-en">In the Explorer panel, click the three-dot icon (â‹®) next to your project ID and select 'Create dataset'.</span></li>
                                        <li><span class="lang lang-ko">'ë°ì´í„°ì„¸íŠ¸ ID'(ì˜ˆ: `ds_test_loaded`)ë¥¼ ì…ë ¥í•˜ê³  'ë°ì´í„°ì„¸íŠ¸ ë§Œë“¤ê¸°'ë¥¼ í´ë¦­í•©ë‹ˆë‹¤.</span><span class="lang lang-en">Enter a 'Dataset ID' (e.g., `ds_test_loaded`) and click 'Create dataset'.</span></li>
                                    </ul>
                                </li>
                                <li>
                                    <strong><span class="lang lang-ko">í…Œì´ë¸” ë§Œë“¤ê¸°:</span><span class="lang lang-en">Create a Table:</span></strong>
                                     <ul class="list-disc list-inside ml-4 mt-2 space-y-1">
                                        <li><span class="lang lang-ko">ë°©ê¸ˆ ë§Œë“  ë°ì´í„°ì„¸íŠ¸ ì˜†ì˜ ì  3ê°œ ì•„ì´ì½˜(â‹®)ì„ í´ë¦­í•˜ê³  'í…Œì´ë¸” ë§Œë“¤ê¸°'ë¥¼ ì„ íƒí•©ë‹ˆë‹¤.</span><span class="lang lang-en">Click the three-dot icon (â‹®) next to the dataset you just created and select 'Create table'.</span></li>
                                        <li><strong><span class="lang lang-ko">ì†ŒìŠ¤:</span><span class="lang lang-en">Source:</span></strong> <span class="lang lang-ko">'ë‹¤ìŒ ìœ„ì¹˜ì—ì„œ í…Œì´ë¸” ë§Œë“¤ê¸°' í•­ëª©ì—ì„œ 'Google Cloud Storage'ë¥¼ ì„ íƒí•©ë‹ˆë‹¤.</span><span class="lang lang-en">Under 'Create table from', select 'Google Cloud Storage'.</span></li>
                                        <li><strong><span class="lang lang-ko">GCS ê²½ë¡œ:</span><span class="lang lang-en">GCS Path:</span></strong> <span class="lang lang-ko">'GCS ë²„í‚·ì—ì„œ íŒŒì¼ ì„ íƒ...' í•„ë“œì— `gs://YOUR_BUCKET_NAME/ds_test/*`ë¥¼ ì…ë ¥í•©ë‹ˆë‹¤.</span><span class="lang lang-en">In the 'Select file from GCS bucket...' field, enter `gs://YOUR_BUCKET_NAME/ds_test/*`.</span></li>
                                        <li><strong><span class="lang lang-ko">íŒŒì¼ í˜•ì‹:</span><span class="lang lang-en">File format:</span></strong> <span class="lang lang-ko">'CSV'ë¥¼ ì„ íƒí•©ë‹ˆë‹¤.</span><span class="lang lang-en">Select 'CSV'.</span></li>
                                    </ul>
                                </li>
                                 <li>
                                    <strong><span class="lang lang-ko">ìŠ¤í‚¤ë§ˆ ë° ì˜µì…˜ ì„¤ì •:</span><span class="lang lang-en">Set Schema and Options:</span></strong>
                                     <ul class="list-disc list-inside ml-4 mt-2 space-y-1">
                                        <li><strong><span class="lang lang-ko">í…Œì´ë¸” ì´ë¦„:</span><span class="lang lang-en">Table name:</span></strong> <span class="lang lang-ko">ë¡œë“œí•  í…Œì´ë¸”ì˜ ì´ë¦„ì„ ì§€ì •í•©ë‹ˆë‹¤. GCSì˜ ê° íŒŒì¼ì´ ë³„ë„ì˜ í…Œì´ë¸”ì´ ë˜ë¯€ë¡œ, íŒŒì¼ë³„ë¡œ ì´ ê³¼ì •ì„ ë°˜ë³µí•´ì•¼ í•©ë‹ˆë‹¤.</span><span class="lang lang-en">Specify the name of the table to load. Since each file in GCS will be a separate table, you must repeat this process for each file.</span></li>
                                        <li><strong><span class="lang lang-ko">ìŠ¤í‚¤ë§ˆ:</span><span class="lang lang-en">Schema:</span></strong> <span class="lang lang-ko">'ìë™ ê°ì§€' ì²´í¬ë°•ìŠ¤ë¥¼ í™œì„±í™”í•©ë‹ˆë‹¤.</span><span class="lang lang-en">Enable the 'Auto detect' checkbox.</span></li>
                                        <li><strong><span class="lang lang-ko">ê³ ê¸‰ ì˜µì…˜:</span><span class="lang lang-en">Advanced options:</span></strong> <span class="lang lang-ko">'í—¤ë” í–‰ ê±´ë„ˆë›°ê¸°' í•„ë“œì— `1`ì„ ì…ë ¥í•˜ì—¬ í—¤ë” ì¤„ì„ ë°ì´í„°ë¡œ ì½ì§€ ì•Šë„ë¡ í•©ë‹ˆë‹¤.</span><span class="lang lang-en">In the 'Header rows to skip' field, enter `1` to prevent the header from being read as data.</span></li>
                                    </ul>
                                </li>
                                <li>
                                    <strong><span class="lang lang-ko">ë¡œë“œ ì™„ë£Œ:</span><span class="lang lang-en">Complete Load:</span></strong>
                                    <ul class="list-disc list-inside ml-4 mt-2 space-y-1">
                                        <li><span class="lang lang-ko">'í…Œì´ë¸” ë§Œë“¤ê¸°' ë²„íŠ¼ì„ í´ë¦­í•©ë‹ˆë‹¤.</span><span class="lang lang-en">Click the 'Create table' button.</span></li>
                                        <li><span class="lang lang-ko">GCS ë²„í‚·ì— ìˆëŠ” ëª¨ë“  CSV íŒŒì¼ì— ëŒ€í•´ 2~4ë‹¨ê³„ë¥¼ ë°˜ë³µí•˜ì—¬ ëª¨ë“  í…Œì´ë¸”ì„ ë¡œë“œí•©ë‹ˆë‹¤.</span><span class="lang lang-en">Repeat steps 2-4 for all CSV files in the GCS bucket to load all tables.</span></li>
                                        <li><span class="lang lang-ko">ë§ˆì§€ë§‰ìœ¼ë¡œ, ìŠ¤í¬ë¦½íŠ¸ ìƒë‹¨ì˜ <code class="text-sm bg-gray-200 rounded px-1 py-0.5">BIGQUERY_TABLE</code> í™˜ê²½ ë³€ìˆ˜ë¥¼ ìƒˆë¡œ ë¡œë“œí•œ í…Œì´ë¸” ê²½ë¡œ(ì˜ˆ: `YOUR_NEW_PROJECT_ID.ds_test_loaded.YOUR_TABLE_NAME`)ë¡œ ìˆ˜ì •í•©ë‹ˆë‹¤.</span><span class="lang lang-en">Finally, update the `BIGQUERY_TABLE` environment variable at the top of the script to the path of the newly loaded table (e.g., `YOUR_NEW_PROJECT_ID.ds_test_loaded.YOUR_TABLE_NAME`).</span></li>
                                    </ul>
                                </li>
                            </ol>
                        </div>
                    </div>

                    <div>
                        <h3 id="execution-prereqs" class="font-semibold text-xl mb-3"><span class="lang lang-ko">4.2. ì‚¬ì „ ì¤€ë¹„ ì‚¬í•­</span><span class="lang lang-en">4.2. Prerequisites</span></h3>
                        <ul class="list-disc list-inside space-y-2 text-gray-600">
                            <li><span class="lang lang-ko">Python 3.8 ì´ìƒ í™˜ê²½</span><span class="lang lang-en">Python 3.8+ environment</span></li>
                            <li><span class="lang lang-ko">í•„ìš”í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜ (ì•„ë˜ ëª…ë ¹ì–´ ì°¸ì¡°)</span><span class="lang lang-en">Required libraries installed (see command below)</span></li>
                            <li><span class="lang lang-ko">Vertex AI, Discovery Engine, BigQuery APIê°€ í™œì„±í™”ëœ Google Cloud í”„ë¡œì íŠ¸</span><span class="lang lang-en">A Google Cloud project with Vertex AI, Discovery Engine, and BigQuery APIs enabled</span></li>
                            <li><span class="lang lang-ko">Google Cloud CLIë¥¼ í†µí•œ ë¡œì»¬ í™˜ê²½ ì¸ì¦ (<code class="text-sm bg-gray-200 rounded px-1 py-0.5">gcloud auth application-default login</code>)</span><span class="lang lang-en">Local environment authenticated via Google Cloud CLI (<code class="text-sm bg-gray-200 rounded px-1 py-0.5">gcloud auth application-default login</code>)</span></li>
                        </ul>
                    </div>
                    
                    <div>
                        <h3 id="execution-install" class="font-semibold text-xl mb-3"><span class="lang lang-ko">4.3. ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜</span><span class="lang lang-en">4.3. Library Installation</span></h3>
                        <div class="relative">
                            <pre><code id="pip-command" class="language-bash">pip install google-adk langchain-google-genai google-cloud-bigquery pandas scikit-learn requests</code></pre>
                        </div>
                    </div>

                    <div>
                        <h3 id="execution-run" class="font-semibold text-xl mb-3"><span class="lang lang-ko">4.4. ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ (ADK)</span><span class="lang lang-en">4.4. Run Script (ADK)</span></h3>
                        <ol class="list-decimal list-inside space-y-2 text-gray-600 mb-4">
                            <li><span class="lang lang-ko">ìœ„ ê°€ì´ë“œì— ë”°ë¼ `agent.py`, `main.py`, `static/index.html` íŒŒì¼ì„ ìƒì„±í•©ë‹ˆë‹¤.</span><span class="lang lang-en">Create `agent.py`, `main.py`, and `static/index.html` files according to the guide above.</span></li>
                            <li><span class="lang lang-ko">`agent.py` íŒŒì¼ ìƒë‹¨ì˜ í™˜ê²½ ë³€ìˆ˜ë“¤ì„ ìì‹ ì˜ í™˜ê²½ì— ë§ê²Œ ìˆ˜ì •í•©ë‹ˆë‹¤.</span><span class="lang lang-en">Modify the environment variables at the top of `agent.py` to match your environment.</span></li>
                            <li><span class="lang lang-ko">í„°ë¯¸ë„ì—ì„œ ì•„ë˜ ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰í•˜ì—¬ ADK ì›¹ ì„œë²„ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤.</span><span class="lang lang-en">Run the command below in your terminal to start the ADK web server.</span></li>
                        </ol>
                        <div class="relative">
                            <pre><code id="run-command" class="language-bash">python main.py</code></pre>
                        </div>
                    </div>
                </div>
            </section>

        </main>
        
        <footer class="text-center mt-16 text-gray-500">
            <p>&copy; 2025 Professional Code Manual. All rights reserved.</p>
        </footer>

    </div>

    <script>
        // Make switchLang globally accessible
        function switchLang(lang) {
            document.documentElement.lang = lang;
            document.documentElement.classList.remove('lang-ko', 'lang-en');
            document.documentElement.classList.add(`lang-${lang}`);
            localStorage.setItem('language', lang);

            const btnKo = document.getElementById('btn-ko');
            const btnEn = document.getElementById('btn-en');

            if (btnKo && btnEn) {
                if (lang === 'ko') {
                    btnKo.classList.add('active');
                    btnEn.classList.remove('active');
                } else {
                    btnEn.classList.add('active');
                    btnKo.classList.remove('active');
                }
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            // --- Initialize Language ---
            const langFromStorage = localStorage.getItem('language');
            const browserLang = (navigator.language || navigator.userLanguage).startsWith('en') ? 'en' : 'ko';
            const initialLang = langFromStorage || browserLang;
            switchLang(initialLang);

            // --- Code Block Selection ---
            const codeBlocks = document.querySelectorAll('pre');
            codeBlocks.forEach(preElement => {
                preElement.style.cursor = 'pointer';
                preElement.setAttribute('title', 'Click to select all code');
                preElement.addEventListener('click', (e) => {
                    e.stopPropagation();
                    
                    const codeElement = preElement.querySelector('code');
                    if (codeElement) {
                        const selection = window.getSelection();
                        const range = document.createRange();
                        range.selectNodeContents(codeElement);
                        selection.removeAllRanges();
                        selection.addRange(range);
                    }
                });
            });

            // --- Sidebar Accordion Menu ---
            const submenuToggles = document.querySelectorAll('[data-toggle-submenu]');
            submenuToggles.forEach(toggle => {
                toggle.addEventListener('click', (e) => {
                    e.preventDefault();
                    const menuItem = toggle.closest('.menu-item');
                    menuItem.classList.toggle('open');
                });
            });

            // --- Sidebar Active Link ---
            const sections = document.querySelectorAll('section[id], div[id^="functions-"], h3[id^="execution-"]');
            const allLinks = document.querySelectorAll('.sidebar a');

            const observer = new IntersectionObserver((entries) => {
                let topmostEntry = null;
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        if (!topmostEntry || entry.boundingClientRect.top < topmostEntry.boundingClientRect.top) {
                            topmostEntry = entry;
                        }
                    }
                });

                if (topmostEntry) {
                    const id = topmostEntry.target.id;
                    const activeLink = document.querySelector(`.sidebar a[href="#${id}"]`);
                    
                    allLinks.forEach(link => link.classList.remove('active'));

                    if (activeLink) {
                        activeLink.classList.add('active');
                        const parentMenuItem = activeLink.closest('.menu-item');
                        if (parentMenuItem) {
                            parentMenuItem.classList.add('open');
                            const parentToggle = parentMenuItem.querySelector('[data-toggle-submenu]');
                            if (parentToggle) {
                                parentToggle.classList.add('active');
                            } else {
                                // For top-level items without a submenu
                                const mainLink = parentMenuItem.querySelector('a');
                                if(mainLink) mainLink.classList.add('active');
                            }
                        }
                    }
                }
            }, {
                threshold: 0,
                rootMargin: '0px 0px -80% 0px'
            });

            sections.forEach(section => {
                observer.observe(section);
            });
        });
    </script>
</body>
</html>
